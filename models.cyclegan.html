<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Defines the CycleGAN model architecture.">

<title>UPIT - CycleGAN model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="UPIT - CycleGAN model">
<meta property="og:description" content="Defines the CycleGAN model architecture.">
<meta property="og:site-name" content="UPIT">
<meta name="twitter:title" content="UPIT - CycleGAN model">
<meta name="twitter:description" content="Defines the CycleGAN model architecture.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">UPIT</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./models.cyclegan.html">Models</a></li><li class="breadcrumb-item"><a href="./models.cyclegan.html">CycleGAN</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Models</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.cyclegan.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">CycleGAN</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.dualgan.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DualGAN</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./models.ganilla.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">GANILLA</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Data Loading</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.unpaired.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Unpaired data loading</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Training</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./train.cyclegan.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CycleGAN</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./train.dualgan.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DualGAN</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./metrics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Metrics</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false">
 <span class="menu-text">Batch Inference</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./inference.cyclegan.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">CycleGAN</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false">
 <span class="menu-text">Tracking</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./tracking.wandb.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Weights and Biases</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#generator" id="toc-generator" class="nav-link active" data-scroll-target="#generator">Generator</a>
  <ul class="collapse">
  <li><a href="#convt_norm_relu" id="toc-convt_norm_relu" class="nav-link" data-scroll-target="#convt_norm_relu">convT_norm_relu</a></li>
  <li><a href="#pad_conv_norm_relu" id="toc-pad_conv_norm_relu" class="nav-link" data-scroll-target="#pad_conv_norm_relu">pad_conv_norm_relu</a></li>
  <li><a href="#resnetblock" id="toc-resnetblock" class="nav-link" data-scroll-target="#resnetblock">ResnetBlock</a></li>
  <li><a href="#resnet_generator" id="toc-resnet_generator" class="nav-link" data-scroll-target="#resnet_generator">resnet_generator</a></li>
  <li><a href="#test-generator" id="toc-test-generator" class="nav-link" data-scroll-target="#test-generator">Test generator</a></li>
  <li><a href="#compare_networks" id="toc-compare_networks" class="nav-link" data-scroll-target="#compare_networks">compare_networks</a></li>
  </ul></li>
  <li><a href="#discriminator" id="toc-discriminator" class="nav-link" data-scroll-target="#discriminator">Discriminator</a>
  <ul class="collapse">
  <li><a href="#conv_norm_lr" id="toc-conv_norm_lr" class="nav-link" data-scroll-target="#conv_norm_lr">conv_norm_lr</a></li>
  <li><a href="#discriminator-1" id="toc-discriminator-1" class="nav-link" data-scroll-target="#discriminator-1">discriminator</a></li>
  <li><a href="#test-discriminator" id="toc-test-discriminator" class="nav-link" data-scroll-target="#test-discriminator">Test discriminator</a></li>
  </ul></li>
  <li><a href="#full-model" id="toc-full-model" class="nav-link" data-scroll-target="#full-model">Full model</a>
  <ul class="collapse">
  <li><a href="#cyclegan" id="toc-cyclegan" class="nav-link" data-scroll-target="#cyclegan">CycleGAN</a></li>
  <li><a href="#cyclegan.__init__" id="toc-cyclegan.__init__" class="nav-link" data-scroll-target="#cyclegan.__init__">CycleGAN.__init__</a></li>
  <li><a href="#cyclegan.forward" id="toc-cyclegan.forward" class="nav-link" data-scroll-target="#cyclegan.forward">CycleGAN.forward</a></li>
  <li><a href="#modelhubmixin.push_to_hub" id="toc-modelhubmixin.push_to_hub" class="nav-link" data-scroll-target="#modelhubmixin.push_to_hub">ModelHubMixin.push_to_hub</a></li>
  <li><a href="#modelhubmixin.from_pretrained" id="toc-modelhubmixin.from_pretrained" class="nav-link" data-scroll-target="#modelhubmixin.from_pretrained">ModelHubMixin.from_pretrained</a></li>
  <li><a href="#quick-model-tests" id="toc-quick-model-tests" class="nav-link" data-scroll-target="#quick-model-tests">Quick model tests</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/tmabraham/UPIT/tree/master/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CycleGAN model</h1>
</div>

<div>
  <div class="description">
    Defines the CycleGAN model architecture.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>We use the models that were introduced in the <a href="https://arxiv.org/abs/1703.10593">cycleGAN paper</a>.</p>
<section id="generator" class="level2">
<h2 class="anchored" data-anchor-id="generator">Generator</h2>
<hr>
<p><a href="https://github.com/tmabraham/UPIT/tree/master/blob/master/upit/models/cyclegan.py#L15" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="convt_norm_relu" class="level3">
<h3 class="anchored" data-anchor-id="convt_norm_relu">convT_norm_relu</h3>
<blockquote class="blockquote">
<pre><code> convT_norm_relu (ch_in:int, ch_out:int,
                  norm_layer:torch.nn.modules.module.Module, ks:int=3,
                  stride:int=2, bias:bool=True)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/tmabraham/UPIT/tree/master/blob/master/upit/models/cyclegan.py#L20" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="pad_conv_norm_relu" class="level3">
<h3 class="anchored" data-anchor-id="pad_conv_norm_relu">pad_conv_norm_relu</h3>
<blockquote class="blockquote">
<pre><code> pad_conv_norm_relu (ch_in:int, ch_out:int, pad_mode:str,
                     norm_layer:torch.nn.modules.module.Module, ks:int=3,
                     bias:bool=True, pad=1, stride:int=1, activ:bool=True,
                     init=&lt;function kaiming_normal_&gt;, init_gain:int=0.02)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/tmabraham/UPIT/tree/master/blob/master/upit/models/junyanz.py#L384" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="resnetblock" class="level3">
<h3 class="anchored" data-anchor-id="resnetblock">ResnetBlock</h3>
<blockquote class="blockquote">
<pre><code> ResnetBlock (dim:int, pad_mode:str='reflection',
              norm_layer:torch.nn.modules.module.Module=None,
              dropout:float=0.0, bias:bool=True)</code></pre>
</blockquote>
<p>nn.Module for the ResNet Block</p>
<hr>
<p><a href="https://github.com/tmabraham/UPIT/tree/master/blob/master/upit/models/cyclegan.py#L52" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="resnet_generator" class="level3">
<h3 class="anchored" data-anchor-id="resnet_generator">resnet_generator</h3>
<blockquote class="blockquote">
<pre><code> resnet_generator (ch_in:int, ch_out:int, n_ftrs:int=64,
                   norm_layer:torch.nn.modules.module.Module=None,
                   dropout:float=0.0, n_blocks:int=9,
                   pad_mode:str='reflection')</code></pre>
</blockquote>
</section>
<section id="test-generator" class="level3">
<h3 class="anchored" data-anchor-id="test-generator">Test generator</h3>
<p>Let’s test for a few things: 1. The generator can indeed be initialized correctly 2. A random image can be passed into the model successfully with the correct size output 3. The CycleGAN generator is equivalent to the <a href="https://github.com/junyanz/pytorch-CycleGAN-and-pix2pix/blob/master/models/cycle_gan_model.py">original implementation</a></p>
<p>First let’s create a random batch:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>img1 <span class="op">=</span> torch.randn(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">256</span>,<span class="dv">256</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> resnet_generator(<span class="dv">3</span>,<span class="dv">3</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    out1 <span class="op">=</span> m(img1)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>out1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([4, 3, 256, 256])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>m_junyanz <span class="op">=</span> define_G(<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">64</span>,<span class="st">'resnet_9blocks'</span>, norm<span class="op">=</span><span class="st">'instance'</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    out2 <span class="op">=</span> m_junyanz(img1)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>out2.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>initialize network with normal</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([4, 3, 256, 256])</code></pre>
</div>
</div>
<hr>
<p><a href="https://github.com/tmabraham/UPIT/tree/master/blob/master/upit/models/cyclegan.py#L68" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="compare_networks" class="level3">
<h3 class="anchored" data-anchor-id="compare_networks">compare_networks</h3>
<blockquote class="blockquote">
<pre><code> compare_networks (a, b)</code></pre>
</blockquote>
<p>A simple function to compare the printed model representations as a proxy for actually comparing two models</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>test_eq(out1.shape,img1.shape)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>test_eq(out2.shape,img1.shape)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> compare_networks(<span class="bu">list</span>(m_junyanz.children())[<span class="dv">0</span>],m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Passed!</code></pre>
</div>
</div>
</section>
</section>
<section id="discriminator" class="level2">
<h2 class="anchored" data-anchor-id="discriminator">Discriminator</h2>
<hr>
<p><a href="https://github.com/tmabraham/UPIT/tree/master/blob/master/upit/models/cyclegan.py#L77" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="conv_norm_lr" class="level3">
<h3 class="anchored" data-anchor-id="conv_norm_lr">conv_norm_lr</h3>
<blockquote class="blockquote">
<pre><code> conv_norm_lr (ch_in:int, ch_out:int,
               norm_layer:torch.nn.modules.module.Module=None, ks:int=3,
               bias:bool=True, pad:int=1, stride:int=1, activ:bool=True,
               slope:float=0.2, init=&lt;function normal_&gt;,
               init_gain:int=0.02)</code></pre>
</blockquote>
<hr>
<p><a href="https://github.com/tmabraham/UPIT/tree/master/blob/master/upit/models/cyclegan.py#L92" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="discriminator-1" class="level3">
<h3 class="anchored" data-anchor-id="discriminator-1">discriminator</h3>
<blockquote class="blockquote">
<pre><code> discriminator (ch_in:int, n_ftrs:int=64, n_layers:int=3,
                norm_layer:torch.nn.modules.module.Module=None,
                sigmoid:bool=False)</code></pre>
</blockquote>
</section>
<section id="test-discriminator" class="level3">
<h3 class="anchored" data-anchor-id="test-discriminator">Test discriminator</h3>
<p>Let’s test for similar things: 1. The discriminator can indeed be initialized correctly 2. A random image can be passed into the discriminator successfully with the correct size output 3. The CycleGAN discriminator is equivalent to the <a href="https://github.com/junyanz/pytorch-CycleGAN-and-pix2pix/blob/master/models/cycle_gan_model.py">original implementation</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> discriminator(<span class="dv">3</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    out1 <span class="op">=</span> d(img1)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>out1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([4, 1, 30, 30])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>img1 <span class="op">=</span> torch.randn(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">256</span>,<span class="dv">256</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>d_junyanz <span class="op">=</span> define_D(<span class="dv">3</span>,<span class="dv">64</span>,<span class="st">'basic'</span>,norm<span class="op">=</span><span class="st">'instance'</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    out2 <span class="op">=</span> d_junyanz(img1)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>out2.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>initialize network with normal</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>torch.Size([4, 1, 30, 30])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>test_eq(out1.shape,torch.Size([<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">30</span>, <span class="dv">30</span>]))</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>test_eq(out2.shape,torch.Size([<span class="dv">4</span>, <span class="dv">1</span>, <span class="dv">30</span>, <span class="dv">30</span>]))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> compare_networks(<span class="bu">list</span>(d_junyanz.children())[<span class="dv">0</span>],d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Passed!</code></pre>
</div>
</div>
</section>
</section>
<section id="full-model" class="level2">
<h2 class="anchored" data-anchor-id="full-model">Full model</h2>
<p>We group two discriminators and two generators in a single model, then a <code>Callback</code> (defined in <code>02_cyclegan_training.ipynb</code>) will take care of training them properly. We use the <code>PyTorchModelHubMixin</code> to provide support for pushing to and loading from the <a href="https://huggingface.co/docs/hub/main">HuggingFace Hub</a>.</p>
<hr>
<p><a href="https://github.com/tmabraham/UPIT/tree/master/blob/master/upit/models/cyclegan.py#L107" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="cyclegan" class="level3">
<h3 class="anchored" data-anchor-id="cyclegan">CycleGAN</h3>
<blockquote class="blockquote">
<pre><code> CycleGAN (ch_in:int=3, ch_out:int=3, n_features:int=64,
           disc_layers:int=3, gen_blocks:int=9, lsgan:bool=True,
           drop:float=0.0, norm_layer:torch.nn.modules.module.Module=None)</code></pre>
</blockquote>
<p>CycleGAN model.</p>
<p>When called, takes in input batch of real images from both domains and outputs fake images for the opposite domains (with the generators). Also outputs identity images after passing the images into generators that outputs its domain type (needed for identity loss).</p>
<p>Attributes:</p>
<p><code>G_A</code> (<code>nn.Module</code>): takes real input B and generates fake input A</p>
<p><code>G_B</code> (<code>nn.Module</code>): takes real input A and generates fake input B</p>
<p><code>D_A</code> (<code>nn.Module</code>): trained to make the difference between real input A and fake input A</p>
<p><code>D_B</code> (<code>nn.Module</code>): trained to make the difference between real input B and fake input B</p>
<hr>
<p><a href="https://github.com/tmabraham/UPIT/tree/master/blob/master/upit/models/cyclegan.py#L119" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="cyclegan.__init__" class="level3">
<h3 class="anchored" data-anchor-id="cyclegan.__init__">CycleGAN.__init__</h3>
<blockquote class="blockquote">
<pre><code> CycleGAN.__init__ (ch_in:int=3, ch_out:int=3, n_features:int=64,
                    disc_layers:int=3, gen_blocks:int=9, lsgan:bool=True,
                    drop:float=0.0,
                    norm_layer:torch.nn.modules.module.Module=None)</code></pre>
</blockquote>
<p>Constructor for CycleGAN model.</p>
<p>Arguments:</p>
<p><code>ch_in</code> (<code>int</code>): Number of input channels (default=3)</p>
<p><code>ch_out</code> (<code>int</code>): Number of output channels (default=3)</p>
<p><code>n_features</code> (<code>int</code>): Number of input features (default=64)</p>
<p><code>disc_layers</code> (<code>int</code>): Number of discriminator layers (default=3)</p>
<p><code>gen_blocks</code> (<code>int</code>): Number of residual blocks in the generator (default=9)</p>
<p><code>lsgan</code> (<code>bool</code>): LSGAN training objective (output unnormalized float) or not? (default=True)</p>
<p><code>drop</code> (<code>float</code>): Level of dropout (default=0)</p>
<p><code>norm_layer</code> (<code>nn.Module</code>): Type of normalization layer to use in the models (default=None)</p>
<hr>
<p><a href="https://github.com/tmabraham/UPIT/tree/master/blob/master/upit/models/cyclegan.py#L146" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="cyclegan.forward" class="level3">
<h3 class="anchored" data-anchor-id="cyclegan.forward">CycleGAN.forward</h3>
<blockquote class="blockquote">
<pre><code> CycleGAN.forward (input)</code></pre>
</blockquote>
<p>Forward function for CycleGAN model. The input is a tuple of a batch of real images from both domains A and B.</p>
<hr>
</section>
<section id="modelhubmixin.push_to_hub" class="level3">
<h3 class="anchored" data-anchor-id="modelhubmixin.push_to_hub">ModelHubMixin.push_to_hub</h3>
<blockquote class="blockquote">
<pre><code> ModelHubMixin.push_to_hub (repo_id:str, config:Optional[dict]=None,
                            commit_message:str='Push model using
                            huggingface_hub.', private:bool=False,
                            api_endpoint:Optional[str]=None,
                            token:Optional[str]=None,
                            branch:Optional[str]=None,
                            create_pr:Optional[bool]=None, allow_patterns:
                            Union[List[str],str,NoneType]=None, ignore_pat
                            terns:Union[List[str],str,NoneType]=None, dele
                            te_patterns:Union[List[str],str,NoneType]=None
                            )</code></pre>
</blockquote>
<p>Upload model checkpoint to the Hub.</p>
<p>Use <code>allow_patterns</code> and <code>ignore_patterns</code> to precisely filter which files should be pushed to the hub. Use <code>delete_patterns</code> to delete existing remote files in the same commit. See [<code>upload_folder</code>] reference for more details.</p>
<p>Args: repo_id (<code>str</code>): ID of the repository to push to (example: <code>"username/my-model"</code>). config (<code>dict</code>, <em>optional</em>): Configuration object to be saved alongside the model weights. commit_message (<code>str</code>, <em>optional</em>): Message to commit while pushing. private (<code>bool</code>, <em>optional</em>, defaults to <code>False</code>): Whether the repository created should be private. api_endpoint (<code>str</code>, <em>optional</em>): The API endpoint to use when pushing the model to the hub. token (<code>str</code>, <em>optional</em>): The token to use as HTTP bearer authorization for remote files. By default, it will use the token cached when running <code>huggingface-cli login</code>. branch (<code>str</code>, <em>optional</em>): The git branch on which to push the model. This defaults to <code>"main"</code>. create_pr (<code>boolean</code>, <em>optional</em>): Whether or not to create a Pull Request from <code>branch</code> with that commit. Defaults to <code>False</code>. allow_patterns (<code>List[str]</code> or <code>str</code>, <em>optional</em>): If provided, only files matching at least one pattern are pushed. ignore_patterns (<code>List[str]</code> or <code>str</code>, <em>optional</em>): If provided, files matching any of the patterns are not pushed. delete_patterns (<code>List[str]</code> or <code>str</code>, <em>optional</em>): If provided, remote files matching any of the patterns will be deleted from the repo.</p>
<p>Returns: The url of the commit of your model in the given repository.</p>
<hr>
</section>
<section id="modelhubmixin.from_pretrained" class="level3">
<h3 class="anchored" data-anchor-id="modelhubmixin.from_pretrained">ModelHubMixin.from_pretrained</h3>
<blockquote class="blockquote">
<pre><code> ModelHubMixin.from_pretrained (cls:Type[~T],
                                pretrained_model_name_or_path:Union[str,pa
                                thlib.Path], force_download:bool=False,
                                resume_download:bool=False,
                                proxies:Optional[Dict]=None,
                                token:Union[bool,str,NoneType]=None, cache
                                _dir:Union[pathlib.Path,str,NoneType]=None
                                , local_files_only:bool=False,
                                revision:Optional[str]=None,
                                **model_kwargs)</code></pre>
</blockquote>
<p>Download a model from the Huggingface Hub and instantiate it.</p>
<p>Args: pretrained_model_name_or_path (<code>str</code>, <code>Path</code>): - Either the <code>model_id</code> (string) of a model hosted on the Hub, e.g.&nbsp;<code>bigscience/bloom</code>. - Or a path to a <code>directory</code> containing model weights saved using [<code>~transformers.PreTrainedModel.save_pretrained</code>], e.g., <code>../path/to/my_model_directory/</code>. revision (<code>str</code>, <em>optional</em>): Revision of the model on the Hub. Can be a branch name, a git tag or any commit id. Defaults to the latest commit on <code>main</code> branch. force_download (<code>bool</code>, <em>optional</em>, defaults to <code>False</code>): Whether to force (re-)downloading the model weights and configuration files from the Hub, overriding the existing cache. resume_download (<code>bool</code>, <em>optional</em>, defaults to <code>False</code>): Whether to delete incompletely received files. Will attempt to resume the download if such a file exists. proxies (<code>Dict[str, str]</code>, <em>optional</em>): A dictionary of proxy servers to use by protocol or endpoint, e.g., <code>{'http': 'foo.bar:3128',         'http://hostname': 'foo.bar:4012'}</code>. The proxies are used on every request. token (<code>str</code> or <code>bool</code>, <em>optional</em>): The token to use as HTTP bearer authorization for remote files. By default, it will use the token cached when running <code>huggingface-cli login</code>. cache_dir (<code>str</code>, <code>Path</code>, <em>optional</em>): Path to the folder where cached files are stored. local_files_only (<code>bool</code>, <em>optional</em>, defaults to <code>False</code>): If <code>True</code>, avoid downloading the file and return the path to the local cached file if it exists. model_kwargs (<code>Dict</code>, <em>optional</em>): Additional kwargs to pass to the model during initialization.</p>
</section>
<section id="quick-model-tests" class="level3">
<h3 class="anchored" data-anchor-id="quick-model-tests">Quick model tests</h3>
<p>Again, let’s check that the model can be called sucsessfully and outputs the correct shapes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>cyclegan_model <span class="op">=</span> CycleGAN()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>img1 <span class="op">=</span> torch.randn(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">256</span>,<span class="dv">256</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>img2 <span class="op">=</span> torch.randn(<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">256</span>,<span class="dv">256</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad(): cyclegan_output <span class="op">=</span> cyclegan_model((img1,img2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>CPU times: user 1min 15s, sys: 6.67 s, total: 1min 22s
Wall time: 2.25 s</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>test_eq(<span class="bu">len</span>(cyclegan_output),<span class="dv">4</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> output_batch <span class="kw">in</span> cyclegan_output:</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    test_eq(output_batch.shape,img1.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>cyclegan_model.push_to_hub(<span class="st">'upit-cyclegan-test'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Cloning https://huggingface.co/tmabraham/upit-cyclegan-test into local empty directory.
To https://huggingface.co/tmabraham/upit-cyclegan-test
   a41e9e0..2331f7d  main -&gt; main
</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c95a20b273084e1a8d9ea94b3cdb7f3c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<pre><code>'https://huggingface.co/tmabraham/upit-cyclegan-test/commit/2331f7d345d719ac1fdfb10b2cddf58abd7931bb'</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>cyclegan_model.from_pretrained(<span class="st">'tmabraham/upit-cyclegan-test'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>