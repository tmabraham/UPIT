---

title: GANILLA model


keywords: fastai
sidebar: home_sidebar

summary: "Defines the GANILLA model architecture."
description: "Defines the GANILLA model architecture."
nb_path: "nbs/09_models.ganilla.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/09_models.ganilla.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We use the generator that was introduced in the <a href="https://arxiv.org/abs/1703.10593">GANILLA paper</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Generator">Generator<a class="anchor-link" href="#Generator"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="BasicBlock_Ganilla" class="doc_header"><code>class</code> <code>BasicBlock_Ganilla</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/ganilla.py#L14" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>BasicBlock_Ganilla</code>(<strong><code>in_planes</code></strong>, <strong><code>planes</code></strong>, <strong><code>use_dropout</code></strong>, <strong><code>stride</code></strong>=<em><code>1</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in
a tree structure. You can assign the submodules as regular attributes::</p>

<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super(Model, self).__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))

</code></pre>
<p>Submodules assigned in this way will be registered, and will have their
parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>:ivar training: Boolean represents whether this module is in training or
                evaluation mode.
:vartype training: bool</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="PyramidFeatures" class="doc_header"><code>class</code> <code>PyramidFeatures</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/ganilla.py#L62" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>PyramidFeatures</code>(<strong><code>C2_size</code></strong>, <strong><code>C3_size</code></strong>, <strong><code>C4_size</code></strong>, <strong><code>C5_size</code></strong>, <strong><code>fpn_weights</code></strong>, <strong><code>feature_size</code></strong>=<em><code>128</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in
a tree structure. You can assign the submodules as regular attributes::</p>

<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super(Model, self).__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))

</code></pre>
<p>Submodules assigned in this way will be registered, and will have their
parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>:ivar training: Boolean represents whether this module is in training or
                evaluation mode.
:vartype training: bool</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ResNet" class="doc_header"><code>class</code> <code>ResNet</code><a href="torchvision/models/resnet.py#L144" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ResNet</code>(<strong><code>block</code></strong>:<code>Type</code>[<code>typing.Union[torchvision.models.resnet.BasicBlock, torchvision.models.resnet.Bottleneck]</code>], <strong><code>layers</code></strong>:<code>List</code>[<code>int</code>], <strong><code>num_classes</code></strong>:<code>int</code>=<em><code>1000</code></em>, <strong><code>zero_init_residual</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>groups</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>width_per_group</code></strong>:<code>int</code>=<em><code>64</code></em>, <strong><code>replace_stride_with_dilation</code></strong>:<code>Optional</code>[<code>List</code>[<code>bool</code>]]=<em><code>None</code></em>, <strong><code>norm_layer</code></strong>:<code>Optional</code>[<code>Callable</code>[<code>Ellipsis</code>, <code>Module</code>]]=<em><code>None</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Base class for all neural network modules.</p>
<p>Your models should also subclass this class.</p>
<p>Modules can also contain other Modules, allowing to nest them in
a tree structure. You can assign the submodules as regular attributes::</p>

<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super(Model, self).__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))

</code></pre>
<p>Submodules assigned in this way will be registered, and will have their
parameters converted too when you call :meth:<code>to</code>, etc.</p>
<p>:ivar training: Boolean represents whether this module is in training or
                evaluation mode.
:vartype training: bool</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="init_weights" class="doc_header"><code>init_weights</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/ganilla.py#L205" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>init_weights</code>(<strong><code>net</code></strong>, <strong><code>init_type</code></strong>=<em><code>'normal'</code></em>, <strong><code>gain</code></strong>=<em><code>0.02</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="ganilla_generator" class="doc_header"><code>ganilla_generator</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/ganilla.py#L228" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>ganilla_generator</code>(<strong><code>input_nc</code></strong>, <strong><code>output_nc</code></strong>, <strong><code>ngf</code></strong>, <strong><code>drop</code></strong>, <strong><code>fpn_weights</code></strong>=<em><code>[1.0, 1.0, 1.0, 1.0]</code></em>, <strong><code>init_type</code></strong>=<em><code>'normal'</code></em>, <strong><code>gain</code></strong>=<em><code>0.02</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>Constructs a ResNet-18 GANILLA generator.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's test for a few things:</p>
<ol>
<li>The generator can indeed be initialized correctly</li>
<li>A random image can be passed into the model successfully with the correct size output</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First let's create a random batch:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">img1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">ganilla_generator</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">64</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span>
<span class="n">out1</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([4, 3, 256, 256])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Full-model">Full model<a class="anchor-link" href="#Full-model"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We group two discriminators and two generators in a single model, then a <code>Callback</code> (defined in <code>02_cyclegan_training.ipynb</code>) will take care of training them properly. The discriminator and training loop is the same as CycleGAN.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="GANILLA" class="doc_header"><code>class</code> <code>GANILLA</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/ganilla.py#L235" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>GANILLA</code>(<strong><code>ch_in</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>ch_out</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>n_features</code></strong>:<code>int</code>=<em><code>64</code></em>, <strong><code>disc_layers</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>lsgan</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>drop</code></strong>:<code>float</code>=<em><code>0.0</code></em>, <strong><code>norm_layer</code></strong>:<code>Module</code>=<em><code>None</code></em>, <strong><code>fpn_weights</code></strong>:<code>list</code>=<em><code>[1.0, 1.0, 1.0, 1.0]</code></em>, <strong><code>init_type</code></strong>:<code>str</code>=<em><code>'normal'</code></em>, <strong><code>gain</code></strong>:<code>float</code>=<em><code>0.02</code></em>, <strong>**<code>kwargs</code></strong>) :: <code>Module</code></p>
</blockquote>
<p>GANILLA model.</p>
<p>When called, takes in input batch of real images from both domains and outputs fake images for the opposite domains (with the generators).
Also outputs identity images after passing the images into generators that outputs its domain type (needed for identity loss).</p>
<p>Attributes:</p>
<p><code>G_A</code> (<code>nn.Module</code>): takes real input B and generates fake input A</p>
<p><code>G_B</code> (<code>nn.Module</code>): takes real input A and generates fake input B</p>
<p><code>D_A</code> (<code>nn.Module</code>): trained to make the difference between real input A and fake input A</p>
<p><code>D_B</code> (<code>nn.Module</code>): trained to make the difference between real input B and fake input B</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="GANILLA.__init__" class="doc_header"><code>GANILLA.__init__</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/ganilla.py#L247" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>GANILLA.__init__</code>(<strong><code>ch_in</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>ch_out</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>n_features</code></strong>:<code>int</code>=<em><code>64</code></em>, <strong><code>disc_layers</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>lsgan</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>drop</code></strong>:<code>float</code>=<em><code>0.0</code></em>, <strong><code>norm_layer</code></strong>:<code>Module</code>=<em><code>None</code></em>, <strong><code>fpn_weights</code></strong>:<code>list</code>=<em><code>[1.0, 1.0, 1.0, 1.0]</code></em>, <strong><code>init_type</code></strong>:<code>str</code>=<em><code>'normal'</code></em>, <strong><code>gain</code></strong>:<code>float</code>=<em><code>0.02</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>Constructor for GANILLA model.</p>
<p>Arguments:</p>
<p><code>ch_in</code> (<code>int</code>): Number of input channels (default=3)</p>
<p><code>ch_out</code> (<code>int</code>): Number of output channels (default=3)</p>
<p><code>n_features</code> (<code>int</code>): Number of input features (default=64)</p>
<p><code>disc_layers</code> (<code>int</code>): Number of discriminator layers (default=3)</p>
<p><code>lsgan</code> (<code>bool</code>): LSGAN training objective (output unnormalized float) or not? (default=True)</p>
<p><code>drop</code> (<code>float</code>): Level of dropout (default=0)</p>
<p><code>norm_layer</code> (<code>nn.Module</code>): Type of normalization layer to use in the discriminator (default=None)
<code>fpn_weights</code> (<code>list</code>): Weights for feature pyramid network (default=[1.0, 1.0, 1.0, 1.0])</p>
<p><code>init_type</code> (<code>str</code>): Type of initialization (default='normal')</p>
<p><code>gain</code> (<code>float</code>): Gain for initialization (default=0.02)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="GANILLA.forward" class="doc_header"><code>GANILLA.forward</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/ganilla.py#L276" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>GANILLA.forward</code>(<strong><code>input</code></strong>)</p>
</blockquote>
<p>Forward function for CycleGAN model. The input is a tuple of a batch of real images from both domains A and B.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Quick-model-tests">Quick model tests<a class="anchor-link" href="#Quick-model-tests"> </a></h3><p>Again, let's check that the model can be called sucsessfully and outputs the correct shapes.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ganilla_model</span> <span class="o">=</span> <span class="n">GANILLA</span><span class="p">()</span>
<span class="n">img1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">)</span>
<span class="n">img2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span> <span class="n">ganilla_output</span> <span class="o">=</span> <span class="n">ganilla_model</span><span class="p">((</span><span class="n">img1</span><span class="p">,</span><span class="n">img2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 42.1 s, sys: 8.36 s, total: 50.5 s
Wall time: 1.38 s
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ganilla_output</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
<span class="k">for</span> <span class="n">output_batch</span> <span class="ow">in</span> <span class="n">ganilla_output</span><span class="p">:</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">output_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ganilla_model</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">(</span><span class="s1">&#39;upit-ganilla-test&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Cloning https://huggingface.co/tmabraham/upit-ganilla-test into local empty directory.
To https://huggingface.co/tmabraham/upit-ganilla-test
   264c8d0..38cafb3  main -&gt; main

</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;https://huggingface.co/tmabraham/upit-ganilla-test/commit/38cafb3d4cca069313b8ed03d88ecc88db28f3d5&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="n">ganilla_model</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;tmabraham/upit-ganilla-test&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>


