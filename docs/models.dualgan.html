---

title: DualGAN model


keywords: fastai
sidebar: home_sidebar

summary: "Defines the DualGAN model architecture."
description: "Defines the DualGAN model architecture."
nb_path: "nbs/07_models.dualgan.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/07_models.dualgan.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We use the models that were introduced in the <a href="https://arxiv.org/abs/1704.02510">DualGAN paper</a>. The original implementation is <a href="https://github.com/duxingren14/DualGAN">here</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Generator">Generator<a class="anchor-link" href="#Generator"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="weights_init_normal" class="doc_header"><code>weights_init_normal</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/dualgan.py#L14" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>weights_init_normal</code>(<strong><code>m</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="UNetUp" class="doc_header"><code>class</code> <code>UNetUp</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/dualgan.py#L39" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>UNetUp</code>(<strong><code>in_size</code></strong>, <strong><code>out_size</code></strong>, <strong><code>dropout</code></strong>=<em><code>0.0</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Expanding layers of the Unet used in DualGAN</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="UNetDown" class="doc_header"><code>class</code> <code>UNetDown</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/dualgan.py#L23" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>UNetDown</code>(<strong><code>in_size</code></strong>, <strong><code>out_size</code></strong>, <strong><code>normalize</code></strong>=<em><code>True</code></em>, <strong><code>dropout</code></strong>=<em><code>0.0</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Contracting layers of the Unet used in DualGAN</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="DualGANGenerator" class="doc_header"><code>class</code> <code>DualGANGenerator</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/dualgan.py#L60" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>DualGANGenerator</code>(<strong><code>channels</code></strong>=<em><code>3</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Generator model for the DualGAN</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-generator">Test generator<a class="anchor-link" href="#Test-generator"> </a></h3><p>Let's test for a few things:</p>
<ol>
<li>The generator can indeed be initialized correctly</li>
<li>A random image can be passed into the model successfully with the correct size output</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First let's create a random batch:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">img1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">DualGANGenerator</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">img1</span><span class="p">)</span>
<span class="n">out1</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>torch.Size([4, 3, 256, 256])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">out1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">]))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Discriminator">Discriminator<a class="anchor-link" href="#Discriminator"> </a></h2><p>As described in the DualGAN paper, we will use a 70x70 PatchGAN, the same discriminator for the CycleGAN.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">D</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Sequential(
  (0): Conv2d(3, 64, kernel_size=(4, 4), stride=(2, 2), padding=(1, 1))
  (1): LeakyReLU(negative_slope=0.2, inplace=True)
  (2): Conv2d(64, 128, kernel_size=(4, 4), stride=(2, 2), padding=(1, 1))
  (3): InstanceNorm2d(128, eps=1e-05, momentum=0.1, affine=False, track_running_stats=False)
  (4): LeakyReLU(negative_slope=0.2, inplace=True)
  (5): Conv2d(128, 256, kernel_size=(4, 4), stride=(2, 2), padding=(1, 1))
  (6): InstanceNorm2d(256, eps=1e-05, momentum=0.1, affine=False, track_running_stats=False)
  (7): LeakyReLU(negative_slope=0.2, inplace=True)
  (8): Conv2d(256, 512, kernel_size=(4, 4), stride=(1, 1), padding=(1, 1))
  (9): InstanceNorm2d(512, eps=1e-05, momentum=0.1, affine=False, track_running_stats=False)
  (10): LeakyReLU(negative_slope=0.2, inplace=True)
  (11): Conv2d(512, 1, kernel_size=(4, 4), stride=(1, 1), padding=(1, 1))
)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="DualGAN" class="doc_header"><code>class</code> <code>DualGAN</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/dualgan.py#L100" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>DualGAN</code>(<strong><code>ch_in</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>n_features</code></strong>:<code>int</code>=<em><code>64</code></em>, <strong><code>disc_layers</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>lsgan</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>drop</code></strong>:<code>float</code>=<em><code>0.0</code></em>, <strong><code>norm_layer</code></strong>:<code>Module</code>=<em><code>None</code></em>) :: <code>Module</code></p>
</blockquote>
<p>DualGAN model.</p>
<p>When called, takes in input batch of real images from both domains and outputs fake images for the opposite domains (with the generators).</p>
<p>Attributes:</p>
<p><code>G_A</code> (<code>nn.Module</code>): takes real input B and generates fake input A</p>
<p><code>G_B</code> (<code>nn.Module</code>): takes real input A and generates fake input B</p>
<p><code>D_A</code> (<code>nn.Module</code>): trained to make the difference between real input A and fake input A</p>
<p><code>D_B</code> (<code>nn.Module</code>): trained to make the difference between real input B and fake input B</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DualGAN.__init__" class="doc_header"><code>DualGAN.__init__</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/dualgan.py#L111" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>DualGAN.__init__</code>(<strong><code>ch_in</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>n_features</code></strong>:<code>int</code>=<em><code>64</code></em>, <strong><code>disc_layers</code></strong>:<code>int</code>=<em><code>3</code></em>, <strong><code>lsgan</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>drop</code></strong>:<code>float</code>=<em><code>0.0</code></em>, <strong><code>norm_layer</code></strong>:<code>Module</code>=<em><code>None</code></em>)</p>
</blockquote>
<p>Constructor for DualGAN model.</p>
<p>Arguments:</p>
<p><code>ch_in</code> (<code>int</code>): Number of input channels (default=3)</p>
<p><code>n_features</code> (<code>int</code>): Number of input features (default=64)</p>
<p><code>disc_layers</code> (<code>int</code>): Number of discriminator layers (default=3)</p>
<p><code>lsgan</code> (<code>bool</code>): LSGAN training objective (output unnormalized float) or not? (default=True)</p>
<p><code>norm_layer</code> (<code>nn.Module</code>): Type of normalization layer to use in the models (default=None)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DualGAN.forward" class="doc_header"><code>DualGAN.forward</code><a href="https://github.com/tmabraham/UPIT/tree/master/upit/models/dualgan.py#L135" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>DualGAN.forward</code>(<strong><code>input</code></strong>)</p>
</blockquote>
<p>Forward function for DualGAN model. The input is a tuple of a batch of real images from both domains A and B.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Quick-model-tests">Quick model tests<a class="anchor-link" href="#Quick-model-tests"> </a></h3><p>Again, let's check that the model can be called sucsessfully and outputs the correct shapes.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dualgan_model</span> <span class="o">=</span> <span class="n">DualGAN</span><span class="p">()</span>
<span class="n">img1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">)</span>
<span class="n">img2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%time</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span> <span class="n">dualgan_output</span> <span class="o">=</span> <span class="n">dualgan_model</span><span class="p">((</span><span class="n">img1</span><span class="p">,</span><span class="n">img2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 18.9 s, sys: 1.57 s, total: 20.5 s
Wall time: 447 ms
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dualgan_output</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
<span class="k">for</span> <span class="n">output_batch</span> <span class="ow">in</span> <span class="n">dualgan_output</span><span class="p">:</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">output_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">img1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dualgan_model</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">(</span><span class="s1">&#39;upit-dualgan-test&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>Cloning https://huggingface.co/tmabraham/upit-dualgan-test into local empty directory.
To https://huggingface.co/tmabraham/upit-dualgan-test
   dccaa0f..f8d92db  main -&gt; main

</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;https://huggingface.co/tmabraham/upit-dualgan-test/commit/f8d92db7854429ca64335e9ab698d7e7f2f44feb&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#hide_output</span>
<span class="n">dualgan_model</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;tmabraham/upit-dualgan-test&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

